<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Great Debaters - Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  </head>
  <body class="min-h-screen bg-gray-900">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <button id="mobileMenuButton" class="lg:hidden text-gray-400 hover:text-white">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <h1 class="text-xl font-bold text-white">The Great Debaters</h1>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-gray-300 text-sm hidden sm:block" id="userWelcome">Welcome!</span>
          <button
            id="newPostBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium"
          >
            <i class="fas fa-plus mr-1"></i>
            <span class="hidden sm:inline">New Post</span>
          </button>
          <button onclick="logout()" class="text-gray-400 hover:text-white">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden">
      <div
        class="fixed left-0 top-0 h-full w-80 bg-gray-800 p-6 transform -translate-x-full transition-transform duration-300"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-white font-semibold">Menu</h3>
          <button id="closeMobileMenu" class="text-gray-400 hover:text-white">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <!-- User Info -->
        <div class="mb-6 p-4 bg-gray-700 rounded-lg">
          <div class="flex items-center space-x-3">
            <div
              class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold"
            >
              U
            </div>
            <div>
              <p class="text-white font-semibold text-sm">User</p>
              <p class="text-gray-400 text-xs" id="mobileAdminStatus">Loading...</p>
            </div>
          </div>
        </div>

        <!-- Mobile Menu Items -->
        <div class="space-y-2">
          <button
            onclick="createPost()"
            class="w-full text-left px-4 py-3 text-white hover:bg-gray-700 rounded-lg flex items-center space-x-3"
          >
            <i class="fas fa-plus w-5"></i>
            <span>Create Post</span>
          </button>
          <button
            onclick="loadPosts()"
            class="w-full text-left px-4 py-3 text-white hover:bg-gray-700 rounded-lg flex items-center space-x-3"
          >
            <i class="fas fa-home w-5"></i>
            <span>Home Feed</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Create Post Modal -->
    <div
      id="createPostModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-gray-800 rounded-lg p-4 sm:p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-white mb-4">Create New Post</h3>

        <!-- Admin Only Message -->
        <div
          id="adminOnlyMessage"
          class="bg-yellow-900 border border-yellow-700 rounded-lg p-3 mb-4 text-yellow-200 text-sm hidden"
        >
          <i class="fas fa-shield-alt mr-2"></i>
          Only admins can create posts
        </div>

        <!-- Image Preview -->
        <div id="imagePreview" class="mb-4 hidden">
          <img id="previewImage" class="w-full rounded-lg max-h-48 object-cover" />
          <div class="flex justify-between items-center mt-2">
            <span id="fileSize" class="text-gray-400 text-sm"></span>
            <button onclick="removeImage()" class="text-red-400 hover:text-red-300 text-sm">
              <i class="fas fa-times mr-1"></i>Remove
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è Large images may take longer to load</p>
        </div>

        <textarea
          id="postContent"
          placeholder="What's on your mind? Start a debate..."
          class="w-full h-32 bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 mb-4 resize-none"
        ></textarea>

        <!-- Image Upload -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2">Add Image (Optional)</label>
          <div class="flex items-center space-x-2">
            <label
              for="imageUpload"
              class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded-lg text-sm border border-gray-600 flex items-center space-x-2"
            >
              <i class="fas fa-image"></i>
              <span class="hidden sm:inline">Choose Image</span>
            </label>
            <input
              type="file"
              id="imageUpload"
              accept="image/*"
              class="hidden"
              onchange="previewImage(this)"
            />
            <span id="fileName" class="text-gray-400 text-sm truncate flex-1"></span>
          </div>
          <p class="text-xs text-gray-500 mt-1">For faster loading, use images under 5MB</p>
        </div>

        <div class="flex justify-end space-x-3">
          <button
            onclick="closeCreatePost()"
            class="px-4 py-2 text-gray-400 hover:text-white text-sm"
          >
            Cancel
          </button>
          <button
            onclick="submitPost()"
            id="submitPostBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <i class="fas fa-paper-plane mr-2"></i>Post
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-3 sm:p-4 lg:p-6">
      <!-- Mobile Admin Badge -->
      <div
        id="mobileAdminBadge"
        class="lg:hidden bg-blue-900 border border-blue-700 rounded-lg p-3 mb-4 text-blue-200 text-sm text-center"
      >
        <i class="fas fa-shield-alt mr-2"></i>
        <span id="adminStatusText">Loading...</span>
      </div>

      <div class="flex flex-col lg:flex-row gap-4 lg:gap-6">
        <!-- Sidebar - Hidden on mobile, shown on desktop -->
        <div class="hidden lg:block w-80 flex-shrink-0">
          <!-- User Info -->
          <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg"
              >
                U
              </div>
              <div>
                <p class="text-white font-semibold">User</p>
                <p class="text-gray-400 text-sm" id="desktopAdminStatus">Loading...</p>
              </div>
            </div>
          </div>

          <!-- Admin Panel -->
          <div id="adminPanel" class="bg-gray-800 rounded-lg p-6 mb-6 hidden">
            <h3 class="text-white font-semibold mb-4 flex items-center">
              <i class="fas fa-shield-alt mr-2 text-blue-400"></i>
              Admin Panel
            </h3>
            <div class="space-y-3 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Admin Status:</span>
                <span class="text-green-400 font-semibold">Active</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Can Post:</span>
                <span class="text-green-400">‚úì</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Can Delete:</span>
                <span class="text-green-400">‚úì</span>
              </div>
            </div>
          </div>

          <!-- Enhanced Community Stats -->
          <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-white font-semibold mb-4">üìä Community Stats</h3>
            <div class="space-y-3 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Total Members</span>
                <span class="text-white" id="totalMembers">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Total Posts</span>
                <span class="text-white" id="totalPosts">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Today's Posts</span>
                <span class="text-green-400" id="todayPosts">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Total Likes</span>
                <span class="text-red-400" id="totalLikes">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Total Comments</span>
                <span class="text-blue-400" id="totalComments">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Your Role</span>
                <span class="text-blue-400" id="userRole">Member</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Posts Feed -->
        <div class="flex-1 min-w-0">
          <!-- Posts will be loaded here -->
          <div id="postsContainer"></div>

          <!-- Loading -->
          <div id="loading" class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
            <p class="text-gray-400 mt-2">Loading posts...</p>
          </div>

          <!-- No Posts Message -->
          <div id="noPosts" class="text-center py-12 hidden">
            <i class="fas fa-comments text-4xl text-gray-600 mb-4"></i>
            <h3 class="text-xl text-white mb-2">No posts yet</h3>
            <p class="text-gray-400 mb-4">Be the first to start a discussion!</p>
            <button
              onclick="createPost()"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
            >
              Create First Post
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyC6CtIlRko2CFf0owSvUlZMeVtkVDMy2BU',
        authDomain: 'the-gd-fste-ce113.firebaseapp.com',
        projectId: 'the-gd-fste-ce113',
        storageBucket: 'the-gd-fste-ce113.appspot.com',
        messagingSenderId: '485167566903',
        appId: '1:485167566903:web:9e5dfacd7e34741cf96fb2',
      };

      // Initialize Firebase
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }

      const auth = firebase.auth();
      const db = firebase.firestore();
      let currentUser = null;
      let selectedImageFile = null;
      let isAdmin = false;
      const adminEmails = ['s.zoubine@edu.umi.ac.ma', 'fatimaezzahraelmouhaddine@gmail.com'];

      // Check authentication
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = 'joinForm.html';
        } else {
          currentUser = user;
          isAdmin = adminEmails.includes(user.email);

          // Update UI based on admin status
          updateAdminUI();
          document.getElementById('userWelcome').textContent = `Welcome, ${
            user.displayName || user.email.split('@')[0]
          }!`;
          loadPosts();
          loadCommunityStats();
        }
      });

      // Update UI based on admin status
      function updateAdminUI() {
        const adminPanel = document.getElementById('adminPanel');
        const adminStatusText = document.getElementById('adminStatusText');
        const desktopAdminStatus = document.getElementById('desktopAdminStatus');
        const userRole = document.getElementById('userRole');
        const newPostBtn = document.getElementById('newPostBtn');
        const mobileAdminStatus = document.getElementById('mobileAdminStatus');

        if (isAdmin) {
          adminPanel?.classList.remove('hidden');
          adminStatusText.textContent = 'Admin - You can create and delete posts';
          desktopAdminStatus.textContent = 'Admin';
          userRole.textContent = 'Admin';
          userRole.className = 'text-green-400';
          mobileAdminStatus.textContent = 'Admin';
          newPostBtn.disabled = false;
        } else {
          adminPanel?.classList.add('hidden');
          adminStatusText.textContent = 'Member - Read only access';
          desktopAdminStatus.textContent = 'Member';
          userRole.textContent = 'Member';
          userRole.className = 'text-blue-400';
          mobileAdminStatus.textContent = 'Member';
          newPostBtn.disabled = true;
          newPostBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }

      // Mobile menu functionality
      document.getElementById('mobileMenuButton').addEventListener('click', function () {
        document.getElementById('mobileSidebar').classList.remove('hidden');
        setTimeout(() => {
          document.querySelector('#mobileSidebar > div').classList.remove('-translate-x-full');
        }, 50);
      });

      document.getElementById('closeMobileMenu').addEventListener('click', function () {
        document.querySelector('#mobileSidebar > div').classList.add('-translate-x-full');
        setTimeout(() => {
          document.getElementById('mobileSidebar').classList.add('hidden');
        }, 300);
      });

      // Close mobile menu when clicking outside
      document.getElementById('mobileSidebar').addEventListener('click', function (e) {
        if (e.target === this) {
          document.querySelector('#mobileSidebar > div').classList.add('-translate-x-full');
          setTimeout(() => {
            this.classList.add('hidden');
          }, 300);
        }
      });

      // FIX: Add event listener for new post button
      document.getElementById('newPostBtn').addEventListener('click', createPost);

      // Enhanced Community Stats
      async function loadCommunityStats() {
        try {
          const postsSnapshot = await db.collection('posts').get();
          const membersSnapshot = await db.collection('members').get();

          // Calculate today's posts
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          let todayPostsCount = 0;
          let totalLikesCount = 0;
          let totalCommentsCount = 0;

          // Calculate stats from all posts
          for (const doc of postsSnapshot.docs) {
            const post = doc.data();
            const postDate = post.createdAt?.toDate();

            // Check if post is from today
            if (postDate && postDate >= today) {
              todayPostsCount++;
            }

            // Get likes count for this post
            const likesSnapshot = await db
              .collection('posts')
              .doc(doc.id)
              .collection('likes')
              .get();
            totalLikesCount += likesSnapshot.size;

            // Get comments count for this post
            const commentsSnapshot = await db
              .collection('posts')
              .doc(doc.id)
              .collection('comments')
              .get();
            totalCommentsCount += commentsSnapshot.size;
          }

          document.getElementById('totalPosts').textContent = postsSnapshot.size;
          document.getElementById('totalMembers').textContent = membersSnapshot.size;
          document.getElementById('todayPosts').textContent = todayPostsCount;
          document.getElementById('totalLikes').textContent = totalLikesCount;
          document.getElementById('totalComments').textContent = totalCommentsCount;
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      // Preview selected image
      function previewImage(input) {
        const file = input.files[0];
        if (file) {
          if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            input.value = '';
            return;
          }

          if (file.size > 5 * 1024 * 1024) {
            alert('Please select an image smaller than 5MB for better performance');
            input.value = '';
            return;
          }

          selectedImageFile = file;
          const reader = new FileReader();

          reader.onload = function (e) {
            document.getElementById('previewImage').src = e.target.result;
            document.getElementById('imagePreview').classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;

            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            document.getElementById('fileSize').textContent = `${fileSize} MB`;
          };

          reader.readAsDataURL(file);
        }
      }

      // Remove selected image
      function removeImage() {
        selectedImageFile = null;
        document.getElementById('imageUpload').value = '';
        document.getElementById('imagePreview').classList.add('hidden');
        document.getElementById('fileName').textContent = '';
      }

      // Convert image to Base64
      function imageToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
          reader.readAsDataURL(file);
        });
      }

      // Load posts from Firebase
      async function loadPosts() {
        const postsContainer = document.getElementById('postsContainer');
        const loading = document.getElementById('loading');
        const noPosts = document.getElementById('noPosts');

        try {
          const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').get();

          loading.classList.add('hidden');
          postsContainer.innerHTML = '';

          if (snapshot.empty) {
            noPosts.classList.remove('hidden');
            return;
          }

          noPosts.classList.add('hidden');

          for (const doc of snapshot.docs) {
            const post = doc.data();
            await renderPost(doc.id, post);
          }
        } catch (error) {
          console.error('Error loading posts:', error);
          loading.innerHTML = '<p class="text-red-400 text-center">Error loading posts</p>';
        }
      }

      // Render a single post
      async function renderPost(postId, post) {
        const postsContainer = document.getElementById('postsContainer');

        try {
          // Get likes count
          const likesSnapshot = await db.collection('posts').doc(postId).collection('likes').get();
          const likesCount = likesSnapshot.size;
          const userLiked = currentUser
            ? await db
                .collection('posts')
                .doc(postId)
                .collection('likes')
                .doc(currentUser.uid)
                .get()
            : { exists: false };

          // Get comments
          const commentsSnapshot = await db
            .collection('posts')
            .doc(postId)
            .collection('comments')
            .orderBy('createdAt', 'asc')
            .get();

          const commentsHtml = commentsSnapshot.docs
            .map(commentDoc => {
              const comment = commentDoc.data();
              return `
                        <div class="bg-gray-700 rounded-lg p-3 mb-2">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-semibold text-blue-400 text-sm">${
                                  comment.authorName
                                }</span>
                                <span class="text-xs text-gray-400">${formatTime(
                                  comment.createdAt?.toDate()
                                )}</span>
                            </div>
                            <p class="text-gray-300 text-sm">${comment.content}</p>
                        </div>
                    `;
            })
            .join('');

          // Social media style image - smaller and more appropriate
          const imageHtml = post.imageUrl
            ? `
                    <div class="mb-4">
                        <img src="${post.imageUrl}" alt="Post image" class="w-full rounded-lg max-h-80 object-contain cursor-pointer" onclick="openImageModal('${post.imageUrl}')">
                    </div>
                `
            : '';

          // Delete button for admins
          const deleteButton = isAdmin
            ? `
                <button onclick="deletePost('${postId}')" class="text-red-400 hover:text-red-300 transition-colors duration-200" title="Delete Post">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            `
            : '';

          const postHtml = `
                    <div class="bg-gray-800 rounded-lg shadow-lg mb-4 sm:mb-6" data-post-id="${postId}">
                        <div class="p-4 sm:p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-bold text-sm">${
                                          post.authorName?.charAt(0) || 'U'
                                        }</span>
                                    </div>
                                    <div>
                                        <h3 class="text-white font-semibold text-sm sm:text-base">${
                                          post.authorName
                                        }</h3>
                                        <p class="text-gray-400 text-xs sm:text-sm">${formatTime(
                                          post.createdAt?.toDate()
                                        )}</p>
                                    </div>
                                </div>
                                ${deleteButton}
                            </div>
                            
                            <p class="text-gray-300 mb-4 leading-relaxed text-sm sm:text-base">${
                              post.content
                            }</p>
                            
                            ${imageHtml}
                            
                            <div class="border-t border-gray-700 pt-4">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex space-x-4 sm:space-x-6">
                                        <button onclick="toggleLike('${postId}')" class="flex items-center space-x-2 ${
            userLiked.exists ? 'text-red-500' : 'text-gray-400 hover:text-red-500'
          } transition-colors duration-200">
                                            <i class="${
                                              userLiked.exists ? 'fas text-red-500' : 'far'
                                            } fa-heart"></i>
                                            <span class="like-count text-xs sm:text-sm">${likesCount}</span>
                                        </button>
                                        <button onclick="toggleComments('${postId}')" class="flex items-center space-x-2 text-gray-400 hover:text-blue-400 transition-colors duration-200">
                                            <i class="far fa-comment"></i>
                                            <span class="text-xs sm:text-sm">${
                                              commentsSnapshot.size
                                            }</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Comments Section -->
                                <div id="comments-${postId}" class="mt-4 hidden">
                                    <div class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                                        ${
                                          commentsHtml ||
                                          '<p class="text-gray-400 text-sm text-center py-4">No comments yet</p>'
                                        }
                                    </div>
                                    <div class="flex space-x-2">
                                        <input type="text" id="commentInput-${postId}" placeholder="Write a comment..." class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-400 focus:outline-none focus:border-blue-500">
                                        <button onclick="addComment('${postId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">Post</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

          postsContainer.innerHTML += postHtml;
        } catch (error) {
          console.error(`Error rendering post ${postId}:`, error);
        }
      }

      // Delete post function for admins
      async function deletePost(postId) {
        if (!isAdmin) {
          alert('Only admins can delete posts');
          return;
        }

        if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
          return;
        }

        try {
          // Delete the post and all its subcollections (likes and comments)
          await db.collection('posts').doc(postId).delete();

          // Remove the post from the UI
          const postElement = document.querySelector(`[data-post-id="${postId}"]`);
          if (postElement) {
            postElement.remove();
          }

          // Reload stats
          loadCommunityStats();

          // Show success message
          alert('Post deleted successfully!');
        } catch (error) {
          console.error('Error deleting post:', error);
          alert('Error deleting post: ' + error.message);
        }
      }

      // Toggle like
      async function toggleLike(postId) {
        if (!currentUser) return;

        try {
          const likeRef = db
            .collection('posts')
            .doc(postId)
            .collection('likes')
            .doc(currentUser.uid);
          const likeDoc = await likeRef.get();

          const postElement = document.querySelector(`[data-post-id="${postId}"]`);
          const likeButton = postElement.querySelector('button[onclick*="toggleLike"]');
          const likeIcon = likeButton.querySelector('i');
          const likeCount = likeButton.querySelector('.like-count');

          if (likeDoc.exists) {
            await likeRef.delete();
            likeIcon.classList.remove('fas', 'text-red-500');
            likeIcon.classList.add('far');
            likeButton.classList.remove('text-red-500');
            likeButton.classList.add('text-gray-400', 'hover:text-red-500');
            const currentCount = parseInt(likeCount.textContent);
            likeCount.textContent = currentCount - 1;
          } else {
            await likeRef.set({
              userId: currentUser.uid,
              likedAt: new Date(),
            });
            likeIcon.classList.remove('far');
            likeIcon.classList.add('fas', 'text-red-500');
            likeButton.classList.remove('text-gray-400', 'hover:text-red-500');
            likeButton.classList.add('text-red-500');
            const currentCount = parseInt(likeCount.textContent);
            likeCount.textContent = currentCount + 1;
          }

          // Update stats after like/unlike
          loadCommunityStats();
        } catch (error) {
          console.error('Error toggling like:', error);
        }
      }

      // Toggle comments section
      function toggleComments(postId) {
        const commentsSection = document.getElementById(`comments-${postId}`);
        commentsSection.classList.toggle('hidden');
      }

      // Add comment
      async function addComment(postId) {
        const commentInput = document.getElementById(`commentInput-${postId}`);
        const content = commentInput.value.trim();

        if (!content || !currentUser) return;

        try {
          await db
            .collection('posts')
            .doc(postId)
            .collection('comments')
            .add({
              content: content,
              authorId: currentUser.uid,
              authorName: currentUser.displayName || 'Anonymous',
              createdAt: new Date(),
            });

          commentInput.value = '';
          await updateCommentsSection(postId);

          // Update stats after adding comment
          loadCommunityStats();
        } catch (error) {
          console.error('Error adding comment:', error);
        }
      }

      // Update comments section
      async function updateCommentsSection(postId) {
        try {
          const commentsSnapshot = await db
            .collection('posts')
            .doc(postId)
            .collection('comments')
            .orderBy('createdAt', 'asc')
            .get();

          const commentsHtml = commentsSnapshot.docs
            .map(commentDoc => {
              const comment = commentDoc.data();
              return `
                        <div class="bg-gray-700 rounded-lg p-3 mb-2">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-semibold text-blue-400 text-sm">${
                                  comment.authorName
                                }</span>
                                <span class="text-xs text-gray-400">${formatTime(
                                  comment.createdAt?.toDate()
                                )}</span>
                            </div>
                            <p class="text-gray-300 text-sm">${comment.content}</p>
                        </div>
                    `;
            })
            .join('');

          const commentsSection = document.getElementById(`comments-${postId}`);
          const commentsContainer = commentsSection.querySelector('.space-y-2');
          commentsContainer.innerHTML =
            commentsHtml || '<p class="text-gray-400 text-sm text-center py-4">No comments yet</p>';
        } catch (error) {
          console.error('Error updating comments:', error);
        }
      }

      // Create post modal
      function createPost() {
        const modal = document.getElementById('createPostModal');
        const adminOnlyMessage = document.getElementById('adminOnlyMessage');
        const submitBtn = document.getElementById('submitPostBtn');

        if (!isAdmin) {
          adminOnlyMessage.classList.remove('hidden');
          submitBtn.disabled = true;
        } else {
          adminOnlyMessage.classList.add('hidden');
          submitBtn.disabled = false;
        }

        modal.classList.remove('hidden');
        document.getElementById('mobileSidebar').classList.add('hidden');
      }

      function closeCreatePost() {
        document.getElementById('createPostModal').classList.add('hidden');
        document.getElementById('postContent').value = '';
        removeImage();
      }

      // Submit new post (Admin only)
      async function submitPost() {
        if (!isAdmin) {
          alert('Only admins can create posts');
          return;
        }

        const content = document.getElementById('postContent').value.trim();

        if (!content && !selectedImageFile) {
          alert('Please add some text or an image to your post');
          return;
        }

        if (!currentUser) return;

        const submitBtn = document.getElementById('submitPostBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        submitBtn.disabled = true;

        try {
          let imageUrl = null;

          if (selectedImageFile) {
            // Convert image to Base64 and store directly in Firestore
            imageUrl = await imageToBase64(selectedImageFile);
          }

          await db.collection('posts').add({
            content: content,
            authorId: currentUser.uid,
            authorName: currentUser.displayName || 'Admin',
            imageUrl: imageUrl,
            createdAt: new Date(),
          });

          closeCreatePost();
          loadPosts();
          loadCommunityStats();
        } catch (error) {
          console.error('Error creating post:', error);
          alert('Error creating post: ' + error.message);
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      // Format time
      function formatTime(date) {
        if (!date) return 'Recently';
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        return date.toLocaleDateString();
      }

      // Open image in modal
      function openImageModal(imageUrl) {
        const modalHtml = `
                <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
                    <div class="max-w-4xl max-h-full">
                        <img src="${imageUrl}" alt="Full size" class="max-w-full max-h-full object-contain">
                        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }

      function closeImageModal() {
        const modal = document.getElementById('imageModal');
        if (modal) modal.remove();
      }

      // Logout
      function logout() {
        auth.signOut();
      }

      // Close modal when clicking outside
      document.getElementById('createPostModal').addEventListener('click', function (e) {
        if (e.target === this) {
          closeCreatePost();
        }
      });
    </script>
  </body>
</html>
