<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Great Debaters - Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
      /* Custom scrollbar for desktop */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #374151;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #6b7280;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gray-900">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <!-- Left side - Logo and mobile menu -->
        <div class="flex items-center space-x-4">
          <!-- Mobile menu button - Hidden on desktop -->
          <button id="mobileMenuButton" class="lg:hidden text-gray-400 hover:text-white">
            <i class="fas fa-bars text-xl"></i>
          </button>

          <!-- Logo - Shows on all devices -->
          <div class="flex items-center space-x-3">
            <div
              class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center"
            >
              <span class="text-white font-bold text-sm">GD</span>
            </div>
            <h1 class="text-xl font-bold text-white hidden sm:block">The Great Debaters</h1>
          </div>
        </div>

        <!-- Right side - User info and actions -->
        <div class="flex items-center space-x-4">
          <!-- User welcome - Hidden on mobile, shown on desktop -->
          <span class="text-gray-300 text-sm hidden md:block" id="userWelcome">Welcome!</span>

          <!-- New Post Button -->
          <button
            id="newPostBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2"
          >
            <i class="fas fa-plus"></i>
            <span class="hidden sm:inline">New Post</span>
          </button>

          <!-- Desktop user menu -->
          <div class="hidden lg:flex items-center space-x-3">
            <div class="flex items-center space-x-2 text-sm">
              <div
                class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center"
              >
                <span class="text-white font-bold text-xs user-initial">U</span>
              </div>
              <span class="text-gray-300 user-name hidden xl:inline">User</span>
            </div>
            <button onclick="logout()" class="text-gray-400 hover:text-white">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>

          <!-- Mobile logout button -->
          <button onclick="logout()" class="lg:hidden text-gray-400 hover:text-white">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden">
      <div
        class="fixed left-0 top-0 h-full w-80 bg-gray-800 p-6 transform -translate-x-full transition-transform duration-300 custom-scrollbar overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-white font-semibold">Menu</h3>
          <button id="closeMobileMenu" class="text-gray-400 hover:text-white">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <!-- User Info -->
        <div class="mb-6 p-4 bg-gray-700 rounded-lg">
          <div class="flex items-center space-x-3">
            <div
              class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold"
            >
              <span class="user-initial">U</span>
            </div>
            <div>
              <p class="text-white font-semibold text-sm user-name">User</p>
              <p class="text-gray-400 text-xs" id="mobileAdminStatus">Loading...</p>
            </div>
          </div>
        </div>

        <!-- Mobile Menu Items -->
        <div class="space-y-2">
          <button
            onclick="createPost()"
            class="w-full text-left px-4 py-3 text-white hover:bg-gray-700 rounded-lg flex items-center space-x-3 transition-colors duration-200"
          >
            <i class="fas fa-plus w-5"></i>
            <span>Create Post</span>
          </button>
          <button
            onclick="loadPosts()"
            class="w-full text-left px-4 py-3 text-white hover:bg-gray-700 rounded-lg flex items-center space-x-3 transition-colors duration-200"
          >
            <i class="fas fa-home w-5"></i>
            <span>Home Feed</span>
          </button>
          <button
            onclick="logout()"
            class="w-full text-left px-4 py-3 text-white hover:bg-gray-700 rounded-lg flex items-center space-x-3 transition-colors duration-200"
          >
            <i class="fas fa-sign-out-alt w-5"></i>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Create Post Modal -->
    <div
      id="createPostModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4"
    >
      <div
        class="bg-gray-800 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto custom-scrollbar"
      >
        <div class="p-6">
          <h3 class="text-xl font-bold text-white mb-4">Create New Post</h3>

          <!-- Admin Only Message -->
          <div
            id="adminOnlyMessage"
            class="bg-yellow-900 border border-yellow-700 rounded-lg p-3 mb-4 text-yellow-200 text-sm hidden"
          >
            <i class="fas fa-shield-alt mr-2"></i>
            Only admins can create posts
          </div>

          <!-- Image Preview -->
          <div id="imagePreview" class="mb-4 hidden">
            <img id="previewImage" class="w-full rounded-lg max-h-64 object-cover" />
            <div class="flex justify-between items-center mt-2">
              <span id="fileSize" class="text-gray-400 text-sm"></span>
              <button onclick="removeImage()" class="text-red-400 hover:text-red-300 text-sm">
                <i class="fas fa-times mr-1"></i>Remove
              </button>
            </div>
          </div>

          <textarea
            id="postContent"
            placeholder="What's on your mind? Start a debate..."
            class="w-full h-40 bg-gray-700 border border-gray-600 rounded-lg p-4 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 mb-4 resize-none text-base"
          ></textarea>

          <!-- Image Upload -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-300 mb-3">Add Image (Optional)</label>
            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
              <label
                for="imageUpload"
                class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-3 rounded-lg text-sm border border-gray-600 flex items-center justify-center space-x-2 transition-colors duration-200 flex-1 sm:flex-none"
              >
                <i class="fas fa-image"></i>
                <span>Choose Image</span>
              </label>
              <input
                type="file"
                id="imageUpload"
                accept="image/*"
                class="hidden"
                onchange="previewImage(this)"
              />
              <span
                id="fileName"
                class="text-gray-400 text-sm truncate flex-1 text-center sm:text-left"
              ></span>
            </div>
          </div>

          <div class="flex justify-end space-x-3 pt-4 border-t border-gray-700">
            <button
              onclick="closeCreatePost()"
              class="px-6 py-2 text-gray-400 hover:text-white text-base transition-colors duration-200"
            >
              Cancel
            </button>
            <button
              onclick="submitPost()"
              id="submitPostBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-base font-medium transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
            >
              <i class="fas fa-paper-plane"></i>
              <span>Post</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-4 lg:p-6">
      <div class="flex flex-col lg:flex-row gap-6 xl:gap-8">
        <!-- Sidebar - Hidden on mobile, shown on desktop -->
        <div class="hidden lg:block w-80 xl:w-96 flex-shrink-0">
          <!-- User Info Card -->
          <div class="bg-gray-800 rounded-xl p-6 mb-6 shadow-lg">
            <div class="flex items-center space-x-4 mb-4">
              <div
                class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl"
              >
                <span class="user-initial">U</span>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-white font-semibold text-lg truncate user-name">User</p>
                <p class="text-gray-400 text-sm" id="desktopAdminStatus">Loading...</p>
              </div>
            </div>
          </div>

          <!-- Admin Panel -->
          <div
            id="adminPanel"
            class="bg-gray-800 rounded-xl p-6 mb-6 shadow-lg border-l-4 border-blue-500 hidden"
          >
            <h3 class="text-white font-semibold mb-4 flex items-center text-lg">
              <i class="fas fa-shield-alt mr-3 text-blue-400"></i>
              Admin Panel
            </h3>
            <div class="space-y-3 text-sm">
              <div class="flex justify-between items-center py-2 border-b border-gray-700">
                <span class="text-gray-400">Status:</span>
                <span class="text-green-400 font-semibold bg-green-900 px-2 py-1 rounded text-xs"
                  >Active</span
                >
              </div>
              <div class="flex justify-between items-center py-2 border-b border-gray-700">
                <span class="text-gray-400">Post Permissions:</span>
                <span class="text-green-400 text-lg">✓</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-gray-400">Role:</span>
                <span class="text-blue-400 font-semibold">Administrator</span>
              </div>
            </div>
          </div>

          <!-- Community Stats -->
          <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
            <h3 class="text-white font-semibold mb-4 text-lg flex items-center">
              <i class="fas fa-chart-bar mr-3 text-green-400"></i>
              Community Stats
            </h3>
            <div class="space-y-4">
              <div class="flex justify-between items-center py-2 border-b border-gray-700">
                <span class="text-gray-400">Total Members</span>
                <span class="text-white font-semibold text-lg" id="totalMembers">0</span>
              </div>
              <div class="flex justify-between items-center py-2 border-b border-gray-700">
                <span class="text-gray-400">Total Posts</span>
                <span class="text-white font-semibold text-lg" id="totalPosts">0</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-gray-400">Your Role</span>
                <span class="text-blue-400 font-semibold" id="userRole">Member</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Posts Feed -->
        <div class="flex-1 min-w-0">
          <!-- Mobile Admin Badge -->
          <div
            id="mobileAdminBadge"
            class="lg:hidden bg-gradient-to-r from-blue-900 to-purple-900 border border-blue-700 rounded-xl p-4 mb-6 text-white text-center shadow-lg"
          >
            <div class="flex items-center justify-center space-x-2 mb-2">
              <i class="fas fa-shield-alt text-blue-300"></i>
              <span class="font-semibold" id="adminStatusText">Loading...</span>
            </div>
            <p class="text-blue-200 text-sm">Only admins can create posts</p>
          </div>

          <!-- Posts Container -->
          <div id="postsContainer" class="space-y-4 lg:space-y-6"></div>

          <!-- Loading -->
          <div id="loading" class="text-center py-12">
            <div
              class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"
            ></div>
            <p class="text-gray-400 text-lg">Loading posts...</p>
          </div>

          <!-- No Posts Message -->
          <div id="noPosts" class="text-center py-16 hidden">
            <div class="max-w-md mx-auto">
              <i class="fas fa-comments text-6xl text-gray-600 mb-6"></i>
              <h3 class="text-2xl text-white mb-3 font-semibold">No posts yet</h3>
              <p class="text-gray-400 text-lg mb-8">
                Be the first to start a discussion in our community!
              </p>
              <button
                onclick="createPost()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg text-lg font-medium transition-colors duration-200 inline-flex items-center space-x-2"
              >
                <i class="fas fa-plus"></i>
                <span>Create First Post</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyC6CtIlRko2CFf0owSvUlZMeVtkVDMy2BU',
        authDomain: 'the-gd-fste-ce113.firebaseapp.com',
        projectId: 'the-gd-fste-ce113',
        storageBucket: 'the-gd-fste-ce113.appspot.com',
        messagingSenderId: '485167566903',
        appId: '1:485167566903:web:9e5dfacd7e34741cf96fb2',
      };

      // Initialize Firebase
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }

      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();
      let currentUser = null;
      let selectedImageFile = null;
      let isAdmin = false;
      const adminEmails = ['s.zoubine@edu.umi.ac.ma', 'fatimaezzahraelmouhaddine@gmail.com'];

      // Check authentication
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = 'joinForm.html';
        } else {
          currentUser = user;
          isAdmin = adminEmails.includes(user.email);

          // Update UI based on admin status
          updateAdminUI();
          document.getElementById('userWelcome').textContent = `Welcome, ${
            user.displayName || user.email.split('@')[0]
          }!`;
          loadPosts();
          loadCommunityStats();

          // Update user info everywhere
          updateUserInfo();
        }
      });

      // Update UI based on admin status
      function updateAdminUI() {
        const adminPanel = document.getElementById('adminPanel');
        const adminStatusText = document.getElementById('adminStatusText');
        const desktopAdminStatus = document.getElementById('desktopAdminStatus');
        const userRole = document.getElementById('userRole');
        const newPostBtn = document.getElementById('newPostBtn');
        const mobileAdminStatus = document.getElementById('mobileAdminStatus');

        if (isAdmin) {
          adminPanel?.classList.remove('hidden');
          adminStatusText.textContent = 'Administrator';
          desktopAdminStatus.textContent = 'Administrator';
          userRole.textContent = 'Admin';
          userRole.className = 'text-green-400 font-semibold';
          mobileAdminStatus.textContent = 'Administrator';
          newPostBtn.disabled = false;
          newPostBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          adminPanel?.classList.add('hidden');
          adminStatusText.textContent = 'Community Member';
          desktopAdminStatus.textContent = 'Community Member';
          userRole.textContent = 'Member';
          userRole.className = 'text-blue-400 font-semibold';
          mobileAdminStatus.textContent = 'Community Member';
          newPostBtn.disabled = true;
          newPostBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }

      // Update user info everywhere
      function updateUserInfo() {
        const userInitial = currentUser?.displayName?.charAt(0) || 'U';
        const userName = currentUser?.displayName || 'User';

        // Update all user initial elements
        document.querySelectorAll('.user-initial').forEach(el => {
          el.textContent = userInitial;
        });

        // Update all user name elements
        document.querySelectorAll('.user-name').forEach(el => {
          el.textContent = userName;
        });
      }

      // Mobile menu functionality
      document.getElementById('mobileMenuButton').addEventListener('click', function () {
        document.getElementById('mobileSidebar').classList.remove('hidden');
        setTimeout(() => {
          document.querySelector('#mobileSidebar > div').classList.remove('-translate-x-full');
        }, 50);
      });

      document.getElementById('closeMobileMenu').addEventListener('click', function () {
        document.querySelector('#mobileSidebar > div').classList.add('-translate-x-full');
        setTimeout(() => {
          document.getElementById('mobileSidebar').classList.add('hidden');
        }, 300);
      });

      // Close mobile menu when clicking outside
      document.getElementById('mobileSidebar').addEventListener('click', function (e) {
        if (e.target === this) {
          document.querySelector('#mobileSidebar > div').classList.add('-translate-x-full');
          setTimeout(() => {
            this.classList.add('hidden');
          }, 300);
        }
      });

      // Load community stats
      async function loadCommunityStats() {
        try {
          const postsSnapshot = await db.collection('posts').get();
          const membersSnapshot = await db.collection('members').get();

          document.getElementById('totalPosts').textContent = postsSnapshot.size;
          document.getElementById('totalMembers').textContent = membersSnapshot.size;
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      // [Rest of the JavaScript functions remain the same as previous version]
      // Preview selected image, removeImage, loadPosts, renderPost, toggleLike,
      // toggleComments, addComment, updateCommentsSection, createPost, closeCreatePost,
      // submitPost, formatTime, logout functions go here...
      // (They are the same as in the previous response)
    </script>
  </body>
</html>
