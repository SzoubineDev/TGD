<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Join The Great Debaters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  </head>
  <body class="min-h-screen bg-gray-800">
    <!-- Welcome Message -->
    <div
      id="welcomeMessage"
      class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-gray-700 rounded-lg p-8 max-w-md mx-4 text-center">
        <h2 class="text-2xl font-bold text-white mb-4">Welcome to The Great Debaters!</h2>
        <p class="text-gray-300 mb-6">You're now part of our community of critical thinkers</p>
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
      </div>
    </div>

    <!-- Success Message -->
    <div
      id="successMessage"
      class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-gray-700 rounded-lg p-8 max-w-md mx-4 text-center">
        <h2 class="text-2xl font-bold text-white mb-4">Account Created Successfully!</h2>
        <p class="text-gray-300 mb-6">
          Your account has been created successfully. Logging you in...
        </p>
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
      </div>
    </div>

    <!-- Login Form -->
    <div id="loginForm" class="min-h-screen flex items-center justify-center p-4">
      <div class="max-w-md w-full">
        <!-- Header -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">The Great Debaters</h1>
          <p class="text-gray-300">Master the Art of Persuasion</p>
        </div>

        <!-- Form Container -->
        <div class="bg-gray-700 rounded-lg shadow-xl p-8">
          <div class="text-center mb-6">
            <h2 id="formTitle" class="text-2xl font-bold text-white mb-2">Become a Member</h2>
            <p id="formSubtitle" class="text-gray-400">Join our community of critical thinkers</p>
          </div>

          <!-- Registration Form -->
          <form id="registrationForm" class="space-y-4">
            <div id="nameField">
              <label class="block text-sm font-medium text-gray-300 mb-1">Full Name *</label>
              <input
                type="text"
                id="fullName"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                placeholder="Enter your full name"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Email *</label>
              <input
                type="email"
                id="email"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                placeholder="Enter your email"
                required
              />
            </div>

            <div id="phoneField">
              <label class="block text-sm font-medium text-gray-300 mb-1">Phone Number *</label>
              <input
                type="tel"
                id="phone"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                placeholder="Enter your phone number"
                required
              />
            </div>

            <div id="specialtyField">
              <label class="block text-sm font-medium text-gray-300 mb-1">Specialty *</label>
              <select
                id="specialty"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                required
              >
                <option value="" disabled selected>Select your specialty</option>
                <option value="DEUST">DEUST</option>
                <option value="LICENSE">LICENSE</option>
                <option value="CYCLE D'Ingenieur">CYCLE D'Ingenieur</option>
                <option value="Master">Master</option>
                <option value="Doctorat">Doctorat</option>
              </select>
            </div>

            <div id="referralField">
              <label class="block text-sm font-medium text-gray-300 mb-1"
                >How did you hear about us? *</label
              >
              <select
                id="referralSource"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                required
              >
                <option value="" disabled selected>Select an option</option>
                <option value="Friend">Friend</option>
                <option value="Facebook">Facebook</option>
                <option value="Instagram">Instagram</option>
                <option value="Twitter">Twitter</option>
                <option value="LinkedIn">LinkedIn</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div id="otherSourceField" class="hidden">
              <label class="block text-sm font-medium text-gray-300 mb-1">Please specify</label>
              <input
                type="text"
                id="otherSource"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                placeholder="Please specify"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Password *</label>
              <input
                type="password"
                id="password"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                placeholder="Enter your password"
                required
              />
            </div>

            <div id="termsField" class="flex items-center">
              <input type="checkbox" id="terms" class="mr-2" required />
              <label for="terms" class="text-sm text-gray-300">
                I agree to the Terms of Service and Privacy Policy
              </label>
            </div>

            <button
              type="submit"
              id="submitButton"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded transition-colors disabled:opacity-50"
            >
              Become a Member
            </button>
          </form>

          <!-- Login Form -->
          <form id="signInForm" class="space-y-4 hidden">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Email *</label>
              <input
                type="email"
                id="loginEmail"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                placeholder="Enter your email"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Password *</label>
              <input
                type="password"
                id="loginPassword"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                placeholder="Enter your password"
                required
              />
            </div>

            <button
              type="submit"
              id="loginButton"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded transition-colors disabled:opacity-50"
            >
              Sign In
            </button>
          </form>

          <div class="flex items-center my-6">
            <div class="flex-1 border-t border-gray-600"></div>
            <div class="px-3 text-gray-400 text-sm">OR</div>
            <div class="flex-1 border-t border-gray-600"></div>
          </div>

          <button
            id="googleSignIn"
            class="w-full bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 rounded flex items-center justify-center space-x-2 border border-gray-300"
          >
            <i class="fab fa-google text-red-500"></i>
            <span>Continue with Google</span>
          </button>

          <div class="text-center mt-6">
            <p class="text-gray-400">
              <span id="toggleText">Already a member?</span>
              <button id="toggleLogin" class="text-blue-400 hover:text-blue-300 font-medium ml-1">
                <span id="toggleButtonText">Sign In</span>
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyC6CtIlRko2CFf0owSvUlZMeVtkVDMy2BU',
        authDomain: 'the-gd-fste-ce113.firebaseapp.com',
        projectId: 'the-gd-fste-ce113',
        storageBucket: 'the-gd-fste-ce113.appspot.com',
        messagingSenderId: '485167566903',
        appId: '1:485167566903:web:9e5dfacd7e34741cf96fb2',
      };

      // Initialize Firebase
      try {
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase initialized successfully');
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }

      const auth = firebase.auth();
      const db = firebase.firestore();

      // DOM Elements
      const registrationForm = document.getElementById('registrationForm');
      const signInForm = document.getElementById('signInForm');
      const googleSignIn = document.getElementById('googleSignIn');
      const referralSource = document.getElementById('referralSource');
      const otherSourceField = document.getElementById('otherSourceField');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const successMessage = document.getElementById('successMessage');
      const loginForm = document.getElementById('loginForm');
      const toggleLogin = document.getElementById('toggleLogin');
      const formTitle = document.getElementById('formTitle');
      const formSubtitle = document.getElementById('formSubtitle');
      const toggleText = document.getElementById('toggleText');
      const toggleButtonText = document.getElementById('toggleButtonText');

      // Form fields for toggling
      const nameField = document.getElementById('nameField');
      const phoneField = document.getElementById('phoneField');
      const specialtyField = document.getElementById('specialtyField');
      const referralField = document.getElementById('referralField');
      const termsField = document.getElementById('termsField');

      // Show/hide other source field
      referralSource.addEventListener('change', function () {
        if (this.value === 'Other') {
          otherSourceField.classList.remove('hidden');
        } else {
          otherSourceField.classList.add('hidden');
        }
      });

      // Toggle between login and registration forms
      let isLoginMode = false;

      toggleLogin.addEventListener('click', function () {
        isLoginMode = !isLoginMode;

        if (isLoginMode) {
          // Switch to login form
          registrationForm.classList.add('hidden');
          signInForm.classList.remove('hidden');
          nameField.classList.add('hidden');
          phoneField.classList.add('hidden');
          specialtyField.classList.add('hidden');
          referralField.classList.add('hidden');
          termsField.classList.add('hidden');
          formTitle.textContent = 'Welcome Back';
          formSubtitle.textContent = 'Sign in to your account';
          toggleText.textContent = "Don't have an account?";
          toggleButtonText.textContent = 'Sign Up';
        } else {
          // Switch to registration form
          registrationForm.classList.remove('hidden');
          signInForm.classList.add('hidden');
          nameField.classList.remove('hidden');
          phoneField.classList.remove('hidden');
          specialtyField.classList.remove('hidden');
          referralField.classList.remove('hidden');
          termsField.classList.remove('hidden');
          formTitle.textContent = 'Become a Member';
          formSubtitle.textContent = 'Join our community of critical thinkers';
          toggleText.textContent = 'Already a member?';
          toggleButtonText.textContent = 'Sign In';
        }
      });

      // Show welcome message and redirect
      function showWelcomeAndRedirect(user) {
        welcomeMessage.classList.remove('hidden');
        loginForm.classList.add('hidden');

        setTimeout(() => {
          window.location.href = 'social.html';
        }, 2000);
      }

      // Show success message and login
      function showSuccessAndLogin(email, password) {
        successMessage.classList.remove('hidden');
        loginForm.classList.add('hidden');

        // Automatically log in the user after successful registration
        setTimeout(async () => {
          try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            showWelcomeAndRedirect(user);
          } catch (error) {
            console.error('Auto-login error:', error);
            // If auto-login fails, redirect to login form
            successMessage.classList.add('hidden');
            loginForm.classList.remove('hidden');
            alert('Account created but login failed. Please sign in manually.');
          }
        }, 2000);
      }

      // Registration Form Submission
      registrationForm.addEventListener('submit', async e => {
        e.preventDefault();

        const fullName = document.getElementById('fullName').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const specialty = document.getElementById('specialty').value;
        const referralSourceValue = document.getElementById('referralSource').value;
        const otherSourceValue = document.getElementById('otherSource').value;
        const password = document.getElementById('password').value;

        const finalReferralSource =
          referralSourceValue === 'Other' ? otherSourceValue : referralSourceValue;

        if (!fullName || !email || !phone || !specialty || !referralSourceValue || !password) {
          alert('Please fill in all required fields');
          return;
        }

        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.textContent = 'Creating Account...';

        try {
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;

          // Update user profile with display name
          await user.updateProfile({
            displayName: fullName,
          });

          await db.collection('members').doc(user.uid).set({
            fullName: fullName,
            email: email,
            phone: phone,
            specialty: specialty,
            referralSource: finalReferralSource,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            uid: user.uid,
          });

          // Show success message and automatically log in
          showSuccessAndLogin(email, password);
          registrationForm.reset();
          otherSourceField.classList.add('hidden');
        } catch (error) {
          console.error('Registration error:', error);
          let errorMessage = 'An error occurred during registration';

          switch (error.code) {
            case 'auth/email-already-in-use':
              errorMessage = 'This email is already registered';
              break;
            case 'auth/invalid-email':
              errorMessage = 'Invalid email address';
              break;
            case 'auth/weak-password':
              errorMessage = 'Password should be at least 6 characters';
              break;
          }

          alert(errorMessage);
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'Become a Member';
        }
      });

      // Login Form Submission
      signInForm.addEventListener('submit', async e => {
        e.preventDefault();

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
          alert('Please fill in all required fields');
          return;
        }

        const loginButton = document.getElementById('loginButton');
        loginButton.disabled = true;
        loginButton.textContent = 'Signing In...';

        try {
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          const user = userCredential.user;
          showWelcomeAndRedirect(user);
        } catch (error) {
          console.error('Login error:', error);
          let errorMessage = 'An error occurred during login';

          switch (error.code) {
            case 'auth/user-not-found':
              errorMessage = 'No account found with this email';
              break;
            case 'auth/wrong-password':
              errorMessage = 'Incorrect password';
              break;
            case 'auth/invalid-email':
              errorMessage = 'Invalid email address';
              break;
          }

          alert(errorMessage);
        } finally {
          loginButton.disabled = false;
          loginButton.textContent = 'Sign In';
        }
      });

      // Google Sign In
      googleSignIn.addEventListener('click', async () => {
        const provider = new firebase.auth.GoogleAuthProvider();

        googleSignIn.disabled = true;
        googleSignIn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Connecting...</span>';

        try {
          const result = await auth.signInWithPopup(provider);
          const user = result.user;

          const memberDoc = await db.collection('members').doc(user.uid).get();

          if (!memberDoc.exists) {
            await db
              .collection('members')
              .doc(user.uid)
              .set({
                fullName: user.displayName || 'Not provided',
                email: user.email,
                phone: 'Not provided',
                specialty: 'Not specified',
                referralSource: 'Google Sign-In',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                uid: user.uid,
                isGoogleUser: true,
              });
          }

          showWelcomeAndRedirect(user);
        } catch (error) {
          console.error('Google sign in error:', error);
          alert('Google Sign-In is not configured yet');
        } finally {
          googleSignIn.disabled = false;
          googleSignIn.innerHTML =
            '<i class="fab fa-google text-red-500"></i><span>Continue with Google</span>';
        }
      });

      // Check if user is already logged in
      auth.onAuthStateChanged(user => {
        if (user) {
          window.location.href = 'social.html';
        }
      });
    </script>
  </body>
</html>
